---
/**
 * ModifierModal - Modal for selecting modifiers before adding to cart
 *
 * Validates min/max selections per group.
 * Calculates total price with modifiers.
 */
---

<dialog id="modifier-modal" class="modal">
  <div class="modal-box max-w-lg">
    <form method="dialog">
      <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">
        <span class="sr-only">Close</span>
        &times;
      </button>
    </form>

    <h3 class="font-bold text-lg mb-1" id="modal-item-name">Item Name</h3>
    <p class="text-sm text-base-content/70 mb-4" id="modal-item-description"></p>

    <div id="modifier-groups" class="space-y-6">
      <!-- Populated dynamically -->
    </div>

    <div class="form-control mt-6">
      <label class="label">
        <span class="label-text">Special Instructions</span>
        <span class="label-text-alt text-base-content/50">Optional</span>
      </label>
      <textarea
        id="modal-special-instructions"
        class="textarea textarea-bordered h-20"
        placeholder="Any allergies or special requests?"
      ></textarea>
    </div>

    <div class="divider"></div>

    <div class="flex justify-between items-center mb-4">
      <div class="flex items-center gap-3">
        <button id="modal-qty-minus" class="btn btn-circle btn-sm btn-outline">-</button>
        <span id="modal-quantity" class="text-lg font-semibold">1</span>
        <button id="modal-qty-plus" class="btn btn-circle btn-sm btn-outline">+</button>
      </div>
      <div class="text-right">
        <div class="text-sm text-base-content/70">Total</div>
        <div id="modal-total-price" class="text-xl font-bold">$0.00</div>
      </div>
    </div>

    <div class="modal-action">
      <form method="dialog">
        <button class="btn btn-ghost">Cancel</button>
      </form>
      <button id="modal-add-to-cart" class="btn btn-primary">
        Add to Cart
      </button>
    </div>
  </div>

  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<script>
  import { addToCart, type CartModifierGroup, type CartModifierSelection } from "@/lib/cart";
  import { isItemAvailable } from "@/lib/availability";
  import type { MenuItem, ModifierGroup, Modifier } from "@/lib/menu";

  interface ModalState {
    item: MenuItem | null;
    quantity: number;
    selectedModifiers: Map<number, Set<number>>; // groupId -> Set of modifier IDs
    specialInstructions: string;
  }

  const state: ModalState = {
    item: null,
    quantity: 1,
    selectedModifiers: new Map(),
    specialInstructions: "",
  };

  const modal = document.getElementById("modifier-modal") as HTMLDialogElement;
  const itemNameEl = document.getElementById("modal-item-name") as HTMLElement;
  const itemDescEl = document.getElementById("modal-item-description") as HTMLElement;
  const groupsContainer = document.getElementById("modifier-groups") as HTMLElement;
  const instructionsEl = document.getElementById("modal-special-instructions") as HTMLTextAreaElement;
  const quantityEl = document.getElementById("modal-quantity") as HTMLElement;
  const totalPriceEl = document.getElementById("modal-total-price") as HTMLElement;
  const addToCartBtn = document.getElementById("modal-add-to-cart") as HTMLButtonElement;
  const qtyMinusBtn = document.getElementById("modal-qty-minus") as HTMLButtonElement;
  const qtyPlusBtn = document.getElementById("modal-qty-plus") as HTMLButtonElement;

  // Open modal event listener
  window.addEventListener("open-modifier-modal", ((e: CustomEvent<MenuItem>) => {
    openModal(e.detail);
  }) as EventListener);

  function openModal(item: MenuItem) {
    state.item = item;
    state.quantity = 1;
    state.selectedModifiers = new Map();
    state.specialInstructions = "";

    // Reset UI
    itemNameEl.textContent = item.name;
    itemDescEl.textContent = item.description || "";
    instructionsEl.value = "";
    quantityEl.textContent = "1";

    // Render modifier groups
    renderModifierGroups(item.modifier_groups || []);

    // Update total
    updateTotalPrice();

    // Show modal
    modal.showModal();
  }

  function renderModifierGroups(groups: ModifierGroup[]) {
    groupsContainer.innerHTML = "";

    groups.forEach((group) => {
      const isRequired = group.min_selections > 0;
      const isMultiSelect = group.max_selections > 1;
      const inputType = isMultiSelect ? "checkbox" : "radio";

      const groupEl = document.createElement("div");
      groupEl.className = "modifier-group";
      groupEl.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <h4 class="font-semibold">${group.name}</h4>
          <span class="text-sm text-base-content/60">
            ${isRequired ? "Required" : "Optional"}
            ${isMultiSelect ? ` (up to ${group.max_selections})` : ""}
          </span>
        </div>
        <div class="space-y-2" data-group-id="${group.id}" data-min="${group.min_selections}" data-max="${group.max_selections}">
          ${group.modifiers
            .map(
              (mod) => `
            <label class="flex items-center gap-3 cursor-pointer p-2 rounded hover:bg-base-200 ${!mod.is_available ? "opacity-50" : ""}">
              <input
                type="${inputType}"
                name="modifier-group-${group.id}"
                value="${mod.id}"
                class="modifier-input ${inputType === "checkbox" ? "checkbox checkbox-primary" : "radio radio-primary"}"
                data-group-id="${group.id}"
                data-modifier-id="${mod.id}"
                data-modifier-name="${mod.name}"
                data-price-adjustment="${mod.price_adjustment}"
                ${!mod.is_available ? "disabled" : ""}
              />
              <span class="flex-grow">${mod.name}</span>
              ${parseFloat(mod.price_adjustment) !== 0 ? `<span class="text-sm text-base-content/70">${parseFloat(mod.price_adjustment) > 0 ? "+" : ""}$${parseFloat(mod.price_adjustment).toFixed(2)}</span>` : ""}
              ${!mod.is_available ? '<span class="badge badge-error badge-xs">86\'d</span>' : ""}
            </label>
          `
            )
            .join("")}
        </div>
      `;

      groupsContainer.appendChild(groupEl);

      // Initialize selected modifiers map for this group
      state.selectedModifiers.set(group.id, new Set());
    });

    // Add change listeners to all modifier inputs
    groupsContainer.querySelectorAll<HTMLInputElement>(".modifier-input").forEach((input) => {
      input.addEventListener("change", handleModifierChange);
    });
  }

  function handleModifierChange(e: Event) {
    const input = e.target as HTMLInputElement;
    const groupId = parseInt(input.dataset.groupId!, 10);
    const modifierId = parseInt(input.dataset.modifierId!, 10);
    const container = input.closest("[data-group-id]") as HTMLElement;
    const maxSelections = parseInt(container.dataset.max!, 10);

    const selectedSet = state.selectedModifiers.get(groupId) || new Set();

    if (input.type === "radio") {
      // Radio buttons: clear and set single selection
      selectedSet.clear();
      if (input.checked) {
        selectedSet.add(modifierId);
      }
    } else {
      // Checkboxes: toggle selection
      if (input.checked) {
        // Check max selections
        if (selectedSet.size >= maxSelections) {
          input.checked = false;
          return;
        }
        selectedSet.add(modifierId);
      } else {
        selectedSet.delete(modifierId);
      }
    }

    state.selectedModifiers.set(groupId, selectedSet);
    updateTotalPrice();
    validateSelections();
  }

  function validateSelections(): boolean {
    if (!state.item) return false;

    let valid = true;
    const groups = state.item.modifier_groups || [];

    groups.forEach((group) => {
      const selectedSet = state.selectedModifiers.get(group.id) || new Set();
      const count = selectedSet.size;

      if (count < group.min_selections) {
        valid = false;
      }
    });

    addToCartBtn.disabled = !valid;
    return valid;
  }

  function calculateTotalPrice(): number {
    if (!state.item) return 0;

    let total = parseFloat(state.item.price);

    // Add modifier prices
    state.selectedModifiers.forEach((modifierIds, groupId) => {
      const group = state.item!.modifier_groups?.find((g) => g.id === groupId);
      if (!group) return;

      modifierIds.forEach((modId) => {
        const modifier = group.modifiers.find((m) => m.id === modId);
        if (modifier) {
          total += parseFloat(modifier.price_adjustment);
        }
      });
    });

    return total * state.quantity;
  }

  function updateTotalPrice() {
    const total = calculateTotalPrice();
    totalPriceEl.textContent = `$${total.toFixed(2)}`;
  }

  // Quantity controls
  qtyMinusBtn.addEventListener("click", () => {
    if (state.quantity > 1) {
      state.quantity--;
      quantityEl.textContent = state.quantity.toString();
      updateTotalPrice();
    }
  });

  qtyPlusBtn.addEventListener("click", () => {
    state.quantity++;
    quantityEl.textContent = state.quantity.toString();
    updateTotalPrice();
  });

  // Special instructions
  instructionsEl.addEventListener("input", () => {
    state.specialInstructions = instructionsEl.value;
  });

  // Add to cart button
  addToCartBtn.addEventListener("click", () => {
    if (!state.item || !validateSelections()) return;

    // Check availability one more time before adding
    if (!isItemAvailable(state.item.id)) {
      const toast = document.createElement("div");
      toast.className = "toast toast-end toast-bottom z-50";
      toast.innerHTML = `
        <div class="alert alert-error">
          <span>${state.item.name} is no longer available</span>
        </div>
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
      modal.close();
      return;
    }

    // Build modifier groups for cart
    const cartModifiers: CartModifierGroup[] = [];

    state.selectedModifiers.forEach((modifierIds, groupId) => {
      const group = state.item!.modifier_groups?.find((g) => g.id === groupId);
      if (!group || modifierIds.size === 0) return;

      const selections: CartModifierSelection[] = [];
      modifierIds.forEach((modId) => {
        const modifier = group.modifiers.find((m) => m.id === modId);
        if (modifier) {
          selections.push({
            id: modifier.id,
            name: modifier.name,
            priceAdjustment: parseFloat(modifier.price_adjustment),
          });
        }
      });

      if (selections.length > 0) {
        cartModifiers.push({
          groupId: group.id,
          groupName: group.name,
          selections,
        });
      }
    });

    // Calculate base price (item price only, modifiers added separately)
    const basePrice = parseFloat(state.item.price);

    // Add to cart
    addToCart({
      menuItemId: state.item.id,
      name: state.item.name,
      basePrice,
      quantity: state.quantity,
      modifiers: cartModifiers,
      specialInstructions: state.specialInstructions,
    });

    // Show feedback
    const toast = document.createElement("div");
    toast.className = "toast toast-end toast-bottom z-50";
    toast.innerHTML = `
      <div class="alert alert-success">
        <span>${state.item.name} added to cart</span>
      </div>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);

    // Dispatch cart update event
    window.dispatchEvent(new CustomEvent("cart-updated"));

    // Close modal
    modal.close();
  });
</script>
