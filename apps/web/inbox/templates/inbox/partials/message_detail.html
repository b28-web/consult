{% load humanize %}

<div class="h-full flex flex-col">
    {# Header #}
    <div class="p-4 border-b">
        <div class="flex items-center justify-between">
            <div>
                <a href="{% url 'crm:contact_detail' message.contact.id %}"
                   class="text-lg font-semibold hover:text-primary transition-colors">
                    {{ message.contact.name }}
                </a>
                <p class="text-sm text-base-content/60">
                    {% if message.contact.email %}{{ message.contact.email }}{% endif %}
                    {% if message.contact.email and message.contact.phone %} &middot; {% endif %}
                    {% if message.contact.phone %}{{ message.contact.phone }}{% endif %}
                </p>
            </div>
            <div class="flex items-center gap-2">
                {% if message.status == 'unread' %}
                <form hx-post="{% url 'inbox:mark' message.id %}"
                      hx-target="#message-{{ message.id }}"
                      hx-swap="outerHTML">
                    <input type="hidden" name="status" value="read">
                    <button type="submit" class="btn btn-sm btn-ghost">
                        Mark as read
                    </button>
                </form>
                {% endif %}
                {% if message.status != 'archived' %}
                <form hx-post="{% url 'inbox:mark' message.id %}"
                      hx-target="#message-{{ message.id }}"
                      hx-swap="outerHTML">
                    <input type="hidden" name="status" value="archived">
                    <button type="submit" class="btn btn-sm btn-ghost">
                        Archive
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>

    {# Message metadata #}
    <div class="px-4 py-2 border-b bg-base-200/50 flex items-center gap-4 text-sm">
        <span class="flex items-center gap-1">
            {% if message.channel == 'form' %}
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Web Form
            {% elif message.channel == 'sms' %}
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
            SMS
            {% elif message.channel == 'voicemail' %}
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
            Voicemail
            {% elif message.channel == 'email' %}
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
            Email
            {% endif %}
        </span>
        <span class="text-base-content/60">{{ message.received_at|naturaltime }}</span>
        {% if message.urgency %}
        <span>
            {% if message.urgency == 'urgent' %}
            <span class="badge badge-error badge-sm">Urgent</span>
            {% elif message.urgency == 'high' %}
            <span class="badge badge-warning badge-sm">High</span>
            {% elif message.urgency == 'medium' %}
            <span class="badge badge-info badge-sm">Medium</span>
            {% else %}
            <span class="badge badge-ghost badge-sm">Low</span>
            {% endif %}
        </span>
        {% endif %}
        {% if message.is_new_lead %}
        <span class="badge badge-success badge-sm">New Lead</span>
        {% endif %}
    </div>

    {# AI Classification (if available) #}
    {% if message.category or message.intent or message.ai_summary %}
    <div class="px-4 py-3 border-b bg-primary/5">
        <div class="flex items-start gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary flex-none mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
            </svg>
            <div class="flex-1">
                {% if message.ai_summary %}
                <p class="text-sm">{{ message.ai_summary }}</p>
                {% endif %}
                {% if message.category or message.intent or message.suggested_action %}
                <div class="flex flex-wrap gap-2 mt-2 text-xs">
                    {% if message.category %}
                    <span class="badge badge-outline badge-sm">{{ message.category }}</span>
                    {% endif %}
                    {% if message.intent %}
                    <span class="badge badge-outline badge-sm">{{ message.intent }}</span>
                    {% endif %}
                    {% if message.suggested_action %}
                    <span class="text-base-content/60">Suggested: {{ message.suggested_action }}</span>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    {# Message body #}
    <div class="flex-1 overflow-y-auto p-4">
        {% if message.subject %}
        <h3 class="font-medium mb-2">{{ message.subject }}</h3>
        {% endif %}
        <div class="prose prose-sm max-w-none">
            {{ message.body|linebreaks }}
        </div>
        {% if message.source_url %}
        <p class="mt-4 text-xs text-base-content/50">
            Submitted from: <a href="{{ message.source_url }}" target="_blank" class="link">{{ message.source_url }}</a>
        </p>
        {% endif %}
    </div>

    {# Contact history #}
    {% include "inbox/partials/contact_history.html" %}

    {# Reply form #}
    <div class="p-4 border-t bg-base-200/50">
        {% if reply_channels %}
        <form hx-post="{% url 'inbox:reply' message.id %}"
              hx-target="#detail-panel"
              hx-swap="innerHTML"
              class="space-y-3">
            <textarea name="body"
                      class="textarea textarea-bordered w-full"
                      rows="3"
                      placeholder="Type your reply..."></textarea>
            <div class="flex items-center justify-between">
                <select name="channel" class="select select-sm select-bordered">
                    {% for ch in reply_channels %}
                    <option value="{{ ch.value }}" {% if ch.default %}selected{% endif %}>
                        {{ ch.label }}
                    </option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-primary btn-sm">
                    Send Reply
                </button>
            </div>
        </form>
        {% else %}
        <p class="text-sm text-base-content/60 italic">
            No contact method available for reply (no email or phone).
        </p>
        {% endif %}
    </div>
</div>
