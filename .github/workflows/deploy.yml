# Deployment Pipeline
# Triggered manually with environment selection
# Gates on pre-deploy validation before deploying
# Uses Doppler for secrets management

name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_validation:
        description: 'Skip pre-deploy validation (use with caution)'
        required: false
        default: false
        type: boolean

concurrency:
  group: deploy-${{ github.event.inputs.environment }}
  cancel-in-progress: false  # Don't cancel ongoing deploys

jobs:
  # ==========================================================================
  # Validate - Run pre-deploy checks
  # ==========================================================================
  validate:
    name: Pre-Deploy Validation
    if: ${{ !inputs.skip_validation }}
    uses: ./.github/workflows/validate.yml

  # ==========================================================================
  # Deploy Worker to Cloudflare
  # ==========================================================================
  deploy-worker:
    name: Deploy Worker
    needs: [validate]
    if: always() && (needs.validate.result == 'success' || inputs.skip_validation)
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install Doppler CLI
        uses: dopplerhq/cli-action@v3

      - name: Install dependencies
        working-directory: workers/intake
        run: pnpm install --frozen-lockfile

      - name: Deploy to Cloudflare Workers
        working-directory: workers/intake
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
        run: |
          # Push secrets from Doppler to Cloudflare Workers
          doppler run -- bash -c 'echo "$NEON_DATABASE_URL" | pnpm wrangler secret put NEON_DATABASE_URL'
          doppler run -- bash -c 'echo "$INTAKE_API_KEY" | pnpm wrangler secret put INTAKE_API_KEY'

          # Deploy worker (CLOUDFLARE_API_TOKEN comes from Doppler)
          doppler run -- pnpm wrangler deploy

  # ==========================================================================
  # Deploy Sites to Cloudflare Pages
  # ==========================================================================
  deploy-sites:
    name: Deploy Sites
    needs: [validate]
    if: always() && (needs.validate.result == 'success' || inputs.skip_validation)
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    strategy:
      matrix:
        site: [coffee-shop]
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install Doppler CLI
        uses: dopplerhq/cli-action@v3

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build site
        working-directory: sites/${{ matrix.site }}
        run: pnpm build

      - name: Deploy to Cloudflare Pages
        working-directory: sites/${{ matrix.site }}
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
        run: |
          # CLOUDFLARE_API_TOKEN and CLOUDFLARE_ACCOUNT_ID come from Doppler
          doppler run -- pnpm wrangler pages deploy dist --project-name=${{ matrix.site }}

  # ==========================================================================
  # Deploy Summary
  # ==========================================================================
  summary:
    name: Deployment Summary
    needs: [validate, deploy-worker, deploy-sites]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validate.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Worker | ${{ needs.deploy-worker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Sites | ${{ needs.deploy-sites.result }} |" >> $GITHUB_STEP_SUMMARY
